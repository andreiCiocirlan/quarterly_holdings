{% extends 'base.html' %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
{% endblock %}

{% block title %}
    {{ filer_name|replace('_', ' ') }} Q{{ filing1.quarter }} {{ filing1.year }} vs Q{{ filing2.quarter }} {{ filing2.year }} 13F Holdings Comparison
{% endblock %}


{% block content %}

        {% set manager_slug = cik|string + '-' + filer_name|replace('_', '-')|lower %}
        <h1>
            <a href="{{ url_for('manager', manager_slug=manager_slug) }}">
                {{ filer_name | replace('_', ' ') }}
            </a>
        </h1>

        <div class="row align-items-center mb-3">
            <div class="col-auto">
                <label for="compareSelect" class="form-label fw-bold">Compare to</label>
            </div>
            <div class="col-auto">
                <select id="compareSelect" class="form-select">
                    <option value="" selected disabled>Select filing to compare</option>
                    {% for accession, year, quarter in all_filings %}
                    {% if accession != filing1.accession_nr and accession != filing2.accession_nr %}
                    <option value="{{ url_for('compare_holdings', accession_nr=latest_accession_nr, compare_accession_nr=accession) }}">
                        Q{{ quarter }} {{ year }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>




        <p>
            Comparing filings:
            <strong>Q{{ filing1.quarter }} {{ filing1.year }}</strong> ({{ filing1.accession_nr }})
            vs.
            <strong>Q{{ filing2.quarter }} {{ filing2.year }}</strong> ({{ filing2.accession_nr }})
        </p>

        <div>
            <table class="table table-striped table-hover" id="comparisonTable">
                <thead>

                <tr>
                    <th></th> <!-- empty first column header -->
                    <th colspan="4" style="text-align:center;">Shares (units)</th>
                    <th colspan="4" style="text-align:center;">Value ($)</th>
                </tr>
                <tr>
                    <th>Ticker</th>
                    <th>Q{{ filing1.quarter }} {{ filing1.year }} Shares</th>
                    <th>Q{{ filing2.quarter }} {{ filing2.year }} Shares</th>
                    <th>Shares Diff</th>
                    <th>Shares Chg %</th>
                    <th>Q{{ filing1.quarter }} {{ filing1.year }} Value</th>
                    <th>Q{{ filing2.quarter }} {{ filing2.year }} Value</th>
                    <th>Value Diff</th>
                    <th>Value Chg %</th>
                </tr>
                </thead>
                <tbody>
                {% for row in comparison %}
                <tr>
                    <td>{{ row.ticker }}</td>

                    <td data-order="{{ row.shares_old }}">{{ row.shares_old | int }}</td>
                    <td data-order="{{ row.shares_new }}">{{ row.shares_new | int }}</td>
                    <td data-order="{{ row.shares_diff }}">{{ row.shares_diff | int }}</td>

                    <td>
                        {% if row.shares_change_pct is none %}
                        N/A
                        {% else %}
                        {{ row.shares_change_pct if row.shares_change_pct in ['NEW', 'REMOVED'] else "%.2f"|format(row.shares_change_pct) + '%' }}
                        {% endif %}
                    </td>

                    <td data-order="{{ row.value_old }}">{{ row.value_old | currency }}</td>
                    <td data-order="{{ row.value_new }}">{{ row.value_new | currency }}</td>
                    <td data-order="{{ row.value_diff }}">{{ row.value_diff | currency }}</td>

                    <td>
                        {% if row.value_change_pct is none %}
                        N/A
                        {% else %}
                        {{ row.value_change_pct if row.value_change_pct in ['NEW', 'REMOVED'] else "%.2f"|format(row.value_change_pct) + '%' }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

{% endblock %}


{% block scripts %}
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="{{ url_for('static', filename='js/compare-utils.js') }}"></script>
{% endblock %}
